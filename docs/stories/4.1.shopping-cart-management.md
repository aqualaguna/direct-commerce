# Story 4.1: Shopping Cart Management

## Status
Draft

## Story
**As a** customer,
**I want** to manage my shopping cart with products, quantities, and pricing,
**so that** I can review my selections and prepare for checkout with accurate totals including taxes and shipping.

## Acceptance Criteria
1. Add/remove products from cart
2. Update product quantities
3. Cart persistence (session/guest/registered user)
4. Cart total calculation with taxes and shipping
5. Cart validation and inventory checks

## Tasks / Subtasks

### Task 1: Shopping Cart Data Model (AC: 1, 2, 3)
- [ ] Create cart data model in `src/api/cart/content-types/cart/schema.json`
- [ ] Create cart item data model in `src/api/cart-item/content-types/cart-item/schema.json`
- [ ] Implement cart session management for guest users
- [ ] Add cart-user relationship for registered users
- [ ] Create cart persistence service in `src/services/cart-persistence.js`
- [ ] Implement cart migration from guest to registered user
- [ ] Add unit tests in `src/api/cart/__tests__/cart.test.ts`

### Task 2: Cart Item Management (AC: 1, 2)
- [ ] Implement add product to cart functionality
- [ ] Add remove product from cart functionality
- [ ] Create update product quantity functionality
- [ ] Implement cart item validation (product exists, active, in stock)
- [ ] Add cart item price calculation and updates
- [ ] Create cart item aggregation and deduplication
- [ ] Add integration tests in `src/api/cart/__tests__/cart-items.test.ts`

### Task 3: Cart Persistence System (AC: 3)
- [ ] Implement session-based cart for guest users
- [ ] Create database persistence for registered users
- [ ] Add cart expiration and cleanup mechanisms
- [ ] Implement cart synchronization between devices
- [ ] Create cart backup and recovery procedures
- [ ] Add cart data migration utilities
- [ ] Implement cart conflict resolution for concurrent updates

### Task 4: Cart Calculation Engine (AC: 4)
- [ ] Create cart subtotal calculation service
- [ ] Implement tax calculation integration
- [ ] Add shipping cost calculation
- [ ] Create discount and coupon application logic
- [ ] Implement cart total aggregation
- [ ] Add currency conversion support
- [ ] Create calculation caching for performance
- [ ] Add calculation validation and error handling

### Task 5: Cart Validation System (AC: 5)
- [ ] Implement inventory availability checking
- [ ] Add product status validation (active, available)
- [ ] Create price validation (current vs. cart price)
- [ ] Implement quantity limit validation
- [ ] Add cart item count limits
- [ ] Create cart expiration validation
- [ ] Implement cart integrity checks
- [ ] Add validation error reporting and user feedback

### Task 6: Cart API and Frontend Integration
- [ ] Create cart API endpoints in `src/api/cart/controllers/cart.js`
- [ ] Implement cart state management in frontend
- [ ] Add real-time cart updates and synchronization
- [ ] Create cart UI components in `src/admin/components/Cart/`
- [ ] Implement cart persistence in browser storage
- [ ] Add cart loading and error states
- [ ] Create cart analytics and tracking
- [ ] Add comprehensive API documentation

## Dev Notes

### Previous Story Insights
- Builds on Epic 2 (Product Catalog Management) - product data and inventory
- Extends Epic 3 (User Management & Authentication) - user identification and session management
- Leverages existing product and user data models for cart functionality
- Integrates with existing authentication system for user identification

### Data Models
**Cart Schema** [Source: architecture/data-models.md#order-model]
```typescript
interface Cart {
  id: string;
  user?: User; // null for guest carts
  sessionId: string; // for guest carts
  items: CartItem[];
  subtotal: number; // in cents
  tax: number; // in cents
  shipping: number; // in cents
  total: number; // in cents
  currency: string;
  expiresAt: Date;
  createdAt: Date;
  updatedAt: Date;
}

interface CartItem {
  id: string;
  cart: Cart;
  product: Product;
  variant?: ProductVariant;
  quantity: number;
  price: number; // in cents (price at time of addition)
  total: number; // in cents (quantity * price)
  addedAt: Date;
  updatedAt: Date;
}

interface CartCalculation {
  subtotal: number; // in cents
  tax: number; // in cents
  shipping: number; // in cents
  discount: number; // in cents
  total: number; // in cents
  currency: string;
  taxRate: number;
  shippingMethod?: string;
  discountCode?: string;
}
```

### API Specifications
**Cart Management Endpoints** [Source: architecture/api-specification.md#order-endpoints]
```yaml
/api/cart:
  get:
    summary: Get current user cart
    security: [bearerAuth]
    responses:
      '200':
        description: Cart details
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Cart'
      '404':
        description: Cart not found

  post:
    summary: Add item to cart
    security: [bearerAuth]
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              productId:
                type: string
              variantId:
                type: string
              quantity:
                type: integer
                minimum: 1
    responses:
      '200':
        description: Item added to cart
      '400':
        description: Invalid request
      '404':
        description: Product not found

/api/cart/items/{itemId}:
  put:
    summary: Update cart item quantity
    security: [bearerAuth]
    parameters:
      - name: itemId
        in: path
        required: true
        schema:
          type: string
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              quantity:
                type: integer
                minimum: 1
    responses:
      '200':
        description: Cart item updated
      '400':
        description: Invalid quantity
      '404':
        description: Cart item not found

  delete:
    summary: Remove item from cart
    security: [bearerAuth]
    parameters:
      - name: itemId
        in: path
        required: true
        schema:
          type: string
    responses:
      '200':
        description: Item removed from cart
      '404':
        description: Cart item not found

/api/cart/clear:
  post:
    summary: Clear all items from cart
    security: [bearerAuth]
    responses:
      '200':
        description: Cart cleared
      '404':
        description: Cart not found

/api/cart/calculate:
  post:
    summary: Calculate cart totals
    security: [bearerAuth]
    requestBody:
      required: false
      content:
        application/json:
          schema:
            type: object
            properties:
              shippingAddress:
                $ref: '#/components/schemas/AddressComponent'
              shippingMethod:
                type: string
              discountCode:
                type: string
    responses:
      '200':
        description: Cart calculation
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CartCalculation'
```

### Component Specifications
**Cart Management UI Components** [Source: architecture/project-structure.md#frontend-structure]
- Location: `src/admin/components/Cart/`
- Components: CartItem, CartSummary, CartActions, CartValidation, CartPersistence
- Props: cart, onUpdate, onRemove, onClear, isGuest, user
- State: cart state, loading state, error state, validation state
- Integration: Product catalog, user management, checkout flow

### File Locations
**Backend Implementation** [Source: architecture/project-structure.md#backend-structure]
- API Controllers: `src/api/cart/controllers/cart.js`
- Services: `src/services/cart-service.js`, `src/services/cart-calculation.js`
- Middlewares: `src/middlewares/cart-validation.js`, `src/middlewares/cart-persistence.js`
- Models: `src/api/cart/content-types/cart/schema.json`
- Tests: `src/api/cart/__tests__/cart.test.js`

**Frontend Implementation**
- Cart Components: `src/admin/components/Cart/`
- API Client: `src/lib/cart-client.js`
- State Management: `src/stores/cart.js`
- Types: `packages/shared/src/types/cart.ts`

### Testing Requirements
**Test Standards** [Source: architecture/test-standard.md#test-structure]
- **Test file location**: `src/api/cart/__tests__/`
- **Test standards**: Follow Jest testing framework with supertest for API testing
- **Testing frameworks**: Jest, supertest, @strapi/test-utils
- **Testing patterns**: Unit tests for services, integration tests for API endpoints, E2E tests for cart flows
- **Specific requirements**: Test all cart CRUD operations, validate calculation accuracy, test persistence mechanisms
- **Coverage requirements**: 75% minimum coverage for cart-related code

### Technical Constraints
**Performance Considerations** [Source: architecture/coding-standards.md#performance]
- Cart operations must complete within 500ms
- Cart calculations must be cached for 5 minutes
- Cart persistence must not block user interactions
- Implement optimistic updates for better UX
- Use database indexes on cart-user relationships

**Security Requirements** [Source: architecture/coding-standards.md#security]
- Cart data must be isolated by user/session
- Implement cart access validation
- Secure cart data transmission
- Validate all cart inputs and calculations
- Implement cart rate limiting to prevent abuse

**Data Integrity Requirements**
- Cart calculations must be accurate to the cent
- Cart items must reference valid products
- Cart expiration must be enforced
- Cart migration must preserve all data
- Implement cart data validation and sanitization

**Version Requirements** [Source: architecture/tech-stack.md]
- Strapi 4.25+ for content management
- Node.js 20+ for modern JavaScript features
- TypeScript 5.9.2+ for type safety
- Jest 30+ for testing framework
- Redis for cart caching (optional)

### Integration Points
- **Product Catalog**: Validate products and get current pricing [Source: architecture/api-specification.md#product-endpoints]
- **User Management**: Identify users and manage cart ownership
- **Inventory System**: Check product availability and stock levels
- **Tax Calculation**: Integrate with tax calculation service
- **Shipping System**: Calculate shipping costs based on cart contents
- **Checkout System**: Transfer cart to order creation

### Project Structure Notes
- Cart data models follow established Strapi patterns
- Cart components integrate with existing product catalog
- API endpoints follow RESTful conventions established in the project
- Test structure aligns with existing testing standards and patterns
- Cart persistence optimized for both guest and registered users

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-26 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
[To be populated by development agent]

### Debug Log References
[To be populated by development agent]

### Completion Notes List
[To be populated by development agent]

### File List
[To be populated by development agent]

## QA Results
[To be populated by QA agent]
