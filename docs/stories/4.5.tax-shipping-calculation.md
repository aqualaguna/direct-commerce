# Story 4.5: Tax and Shipping Calculation

## Status
Draft

## Story
**As a** customer,
**I want** accurate tax and shipping calculations based on my location and preferences,
**so that** I can see the true total cost of my purchase and choose the most suitable shipping option.

## Acceptance Criteria
1. Tax calculation based on location
2. Multiple shipping options and rates
3. Shipping address validation
4. Tax rate management
5. Shipping cost calculation

## Tasks / Subtasks

### Task 1: Tax Calculation System (AC: 1, 4)
- [ ] Create tax rate data model in `src/api/tax-rate/content-types/tax-rate/schema.json`
- [ ] Create tax calculation data model in `src/api/tax-calculation/content-types/tax-calculation/schema.json`
- [ ] Implement tax calculation service in `src/services/tax-calculation.js`
- [ ] Add location-based tax rate lookup
- [ ] Create tax rate management for different jurisdictions
- [ ] Implement tax exemption handling
- [ ] Add tax calculation caching for performance
- [ ] Add unit tests in `src/api/tax-rate/__tests__/tax-calculation.test.ts`

### Task 2: Shipping Options and Rates (AC: 2, 5)
- [ ] Create shipping method data model in `src/api/shipping-method/content-types/shipping-method/schema.json`
- [ ] Create shipping rate data model in `src/api/shipping-rate/content-types/shipping-rate/schema.json`
- [ ] Implement shipping calculation service in `src/services/shipping-calculation.js`
- [ ] Add multiple shipping carrier integration
- [ ] Create shipping rate calculation algorithms
- [ ] Implement shipping method availability checking
- [ ] Add shipping rate caching and optimization
- [ ] Add integration tests in `src/api/shipping-method/__tests__/shipping-calculation.test.ts`

### Task 3: Address Validation System (AC: 3)
- [ ] Create address validation data model in `src/api/address-validation/content-types/address-validation/schema.json`
- [ ] Implement address validation service in `src/services/address-validation.js`
- [ ] Add address geocoding and verification
- [ ] Create address format standardization
- [ ] Implement address validation caching
- [ ] Add address validation error handling
- [ ] Create address validation analytics
- [ ] Add address validation tests in `src/api/address-validation/__tests__/address-validation.test.ts`

### Task 4: Tax Rate Management (AC: 4)
- [ ] Create tax jurisdiction data model in `src/api/tax-jurisdiction/content-types/tax-jurisdiction/schema.json`
- [ ] Implement tax rate management service in `src/services/tax-rate-management.js`
- [ ] Add tax rate import and export functionality
- [ ] Create tax rate update automation
- [ ] Implement tax rate validation and verification
- [ ] Add tax rate change tracking and audit
- [ ] Create tax rate management dashboard
- [ ] Add tax rate management tests in `src/api/tax-jurisdiction/__tests__/tax-rate-management.test.ts`

### Task 5: Shipping Cost Calculation (AC: 5)
- [ ] Create shipping cost data model in `src/api/shipping-cost/content-types/shipping-cost/schema.json`
- [ ] Implement shipping cost calculation service in `src/services/shipping-cost-calculation.js`
- [ ] Add weight-based shipping calculations
- [ ] Create distance-based shipping calculations
- [ ] Implement shipping cost optimization
- [ ] Add shipping cost estimation for different carriers
- [ ] Create shipping cost comparison tools
- [ ] Add shipping cost calculation tests in `src/api/shipping-cost/__tests__/shipping-cost-calculation.test.ts`

### Task 6: Tax and Shipping API Integration
- [ ] Create tax and shipping API endpoints in `src/api/tax-shipping/controllers/tax-shipping.js`
- [ ] Implement tax and shipping state management in frontend
- [ ] Add real-time tax and shipping calculations
- [ ] Create tax and shipping UI components in `src/admin/components/TaxShipping/`
- [ ] Implement tax and shipping configuration management
- [ ] Add tax and shipping analytics and reporting
- [ ] Create comprehensive tax and shipping documentation
- [ ] Add end-to-end tax and shipping flow testing

## Dev Notes

### Previous Story Insights
- Builds on Story 4.1 (Shopping Cart Management) - cart totals and calculation
- Extends Story 4.2 (Checkout Process Implementation) - address collection
- Leverages Story 4.4 (Order Creation and Management) - order total calculations
- Integrates with existing address and product data models for calculations

### Data Models
**Tax Rate Schema** [Source: architecture/data-models.md#address-model]
```typescript
interface TaxRate {
  id: string;
  jurisdiction: TaxJurisdiction;
  rate: number; // percentage (e.g., 8.5 for 8.5%)
  rateType: 'percentage' | 'fixed';
  appliesTo: 'all' | 'specific_products' | 'product_categories';
  productCategories?: string[];
  products?: string[];
  isActive: boolean;
  effectiveDate: Date;
  expirationDate?: Date;
  createdAt: Date;
  updatedAt: Date;
}

interface TaxJurisdiction {
  id: string;
  name: string;
  type: 'country' | 'state' | 'county' | 'city';
  country: string;
  state?: string;
  county?: string;
  city?: string;
  postalCode?: string;
  taxCode: string;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}

interface TaxCalculation {
  id: string;
  order?: Order;
  cart?: Cart;
  jurisdiction: TaxJurisdiction;
  subtotal: number; // in cents
  taxableAmount: number; // in cents
  taxAmount: number; // in cents
  taxRate: number; // percentage
  taxBreakdown: TaxBreakdown[];
  calculatedAt: Date;
  createdAt: Date;
  updatedAt: Date;
}

interface TaxBreakdown {
  id: string;
  taxCalculation: TaxCalculation;
  productId?: string;
  categoryId?: string;
  taxableAmount: number; // in cents
  taxAmount: number; // in cents
  taxRate: number; // percentage
  description: string;
  createdAt: Date;
  updatedAt: Date;
}

interface ShippingMethod {
  id: string;
  name: string;
  code: string;
  carrier: string;
  serviceLevel: 'economy' | 'standard' | 'express' | 'overnight';
  isActive: boolean;
  isDefault: boolean;
  estimatedDays: number;
  maxWeight?: number; // in grams
  maxDimensions?: {
    length: number;
    width: number;
    height: number;
  };
  restrictions?: string[];
  createdAt: Date;
  updatedAt: Date;
}

interface ShippingRate {
  id: string;
  shippingMethod: ShippingMethod;
  originAddress: AddressComponent;
  destinationAddress: AddressComponent;
  weight: number; // in grams
  dimensions?: {
    length: number;
    width: number;
    height: number;
  };
  baseRate: number; // in cents
  additionalRate?: number; // in cents per additional unit
  totalRate: number; // in cents
  currency: string;
  estimatedDays: number;
  isAvailable: boolean;
  createdAt: Date;
  updatedAt: Date;
}

interface AddressValidation {
  id: string;
  originalAddress: AddressComponent;
  validatedAddress: AddressComponent;
  isValid: boolean;
  confidence: number; // 0-100
  suggestions?: AddressComponent[];
  geocode?: {
    latitude: number;
    longitude: number;
  };
  validationErrors?: string[];
  validatedAt: Date;
  createdAt: Date;
  updatedAt: Date;
}
```

### API Specifications
**Tax and Shipping Endpoints** [Source: architecture/api-specification.md#order-endpoints]
```yaml
/api/tax/calculate:
  post:
    summary: Calculate tax for order or cart
    security: [bearerAuth]
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              subtotal:
                type: integer
              shippingAddress:
                $ref: '#/components/schemas/AddressComponent'
              items:
                type: array
                items:
                  type: object
                  properties:
                    productId:
                      type: string
                    quantity:
                      type: integer
                    price:
                      type: integer
    responses:
      '200':
        description: Tax calculation result
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaxCalculation'
      '400':
        description: Invalid request

/api/shipping/rates:
  post:
    summary: Get shipping rates for address
    security: [bearerAuth]
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              originAddress:
                $ref: '#/components/schemas/AddressComponent'
              destinationAddress:
                $ref: '#/components/schemas/AddressComponent'
              weight:
                type: number
              dimensions:
                type: object
                properties:
                  length:
                    type: number
                  width:
                    type: number
                  height:
                    type: number
    responses:
      '200':
        description: Available shipping rates
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/ShippingRate'
      '400':
        description: Invalid request

/api/shipping/methods:
  get:
    summary: Get available shipping methods
    security: [bearerAuth]
    parameters:
      - name: originCountry
        in: query
        schema:
          type: string
      - name: destinationCountry
        in: query
        schema:
          type: string
    responses:
      '200':
        description: Available shipping methods
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/ShippingMethod'
      '400':
        description: Invalid request

/api/address/validate:
  post:
    summary: Validate shipping address
    security: [bearerAuth]
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AddressComponent'
    responses:
      '200':
        description: Address validation result
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddressValidation'
      '400':
        description: Invalid address

/api/tax/rates:
  get:
    summary: Get tax rates for jurisdiction
    security: [bearerAuth]
    parameters:
      - name: country
        in: query
        required: true
        schema:
          type: string
      - name: state
        in: query
        schema:
          type: string
      - name: city
        in: query
        schema:
          type: string
      - name: postalCode
        in: query
        schema:
          type: string
    responses:
      '200':
        description: Tax rates for jurisdiction
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/TaxRate'
      '400':
        description: Invalid jurisdiction

/api/tax/jurisdictions:
  get:
    summary: Get tax jurisdictions
    security: [bearerAuth]
    parameters:
      - name: country
        in: query
        schema:
          type: string
      - name: type
        in: query
        schema:
          type: string
          enum: [country, state, county, city]
    responses:
      '200':
        description: Tax jurisdictions
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/TaxJurisdiction'
      '400':
        description: Invalid request
```

### Component Specifications
**Tax and Shipping Management UI Components** [Source: architecture/project-structure.md#frontend-structure]
- Location: `src/admin/components/TaxShipping/`
- Components: TaxCalculator, ShippingRateCalculator, AddressValidator, TaxRateManager, ShippingMethodManager
- Props: address, items, subtotal, onCalculationComplete, onRateSelect, onAddressValidated
- State: calculation state, loading state, error state, validation state, rate state
- Integration: Cart management, checkout flow, order management, address management

### File Locations
**Backend Implementation** [Source: architecture/project-structure.md#backend-structure]
- API Controllers: `src/api/tax-shipping/controllers/tax-shipping.js`
- Services: `src/services/tax-calculation.js`, `src/services/shipping-calculation.js`, `src/services/address-validation.js`
- Middlewares: `src/middlewares/tax-validation.js`, `src/middlewares/shipping-validation.js`
- Models: `src/api/tax-rate/content-types/tax-rate/schema.json`
- Tests: `src/api/tax-shipping/__tests__/tax-shipping.test.js`

**Frontend Implementation**
- Tax and Shipping Components: `src/admin/components/TaxShipping/`
- API Client: `src/lib/tax-shipping-client.js`
- State Management: `src/stores/tax-shipping.js`
- Types: `packages/shared/src/types/tax-shipping.ts`

### Testing Requirements
**Test Standards** [Source: architecture/test-standard.md#test-structure]
- **Test file location**: `src/api/tax-shipping/__tests__/`
- **Test standards**: Follow Jest testing framework with supertest for API testing
- **Testing frameworks**: Jest, supertest, @strapi/test-utils
- **Testing patterns**: Unit tests for services, integration tests for API endpoints, E2E tests for calculation flows
- **Specific requirements**: Test all tax and shipping calculations, validate address handling, test rate management
- **Coverage requirements**: 85% minimum coverage for tax and shipping code due to critical financial nature

### Technical Constraints
**Performance Considerations** [Source: architecture/coding-standards.md#performance]
- Tax calculations must complete within 1 second
- Shipping rate calculations must complete within 2 seconds
- Address validation must complete within 500ms
- All calculations must be cached for 5 minutes
- Implement calculation result caching for performance

**Accuracy Requirements**
- Tax calculations must be accurate to the cent
- Shipping rates must be real-time and current
- Address validation must be reliable and consistent
- Tax rates must be up-to-date and compliant
- All calculations must be auditable and traceable

**Compliance Requirements**
- Tax calculations must comply with local tax laws
- Shipping rates must be accurate and transparent
- Address validation must meet postal service standards
- Tax rate management must support regulatory changes
- All calculations must be documented and verifiable

**Version Requirements** [Source: architecture/tech-stack.md]
- Strapi 4.25+ for content management
- Node.js 20+ for modern JavaScript features
- TypeScript 5.9.2+ for type safety
- Jest 30+ for testing framework
- External tax calculation APIs (optional)
- Shipping carrier APIs (optional)

### Integration Points
- **Shopping Cart**: Calculate tax and shipping for cart totals [Source: architecture/api-specification.md#cart-endpoints]
- **Checkout System**: Validate addresses and calculate final totals
- **Order Management**: Apply tax and shipping to order calculations
- **Address Management**: Validate and standardize addresses
- **Product Catalog**: Get product information for tax calculations
- **External APIs**: Integrate with tax calculation and shipping carrier services

### Project Structure Notes
- Tax and shipping data models follow established Strapi patterns
- Tax and shipping components integrate with existing cart and checkout systems
- API endpoints follow RESTful conventions established in the project
- Test structure aligns with existing testing standards and patterns
- Tax and shipping calculations optimized for accuracy and performance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-26 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
[To be populated by development agent]

### Debug Log References
[To be populated by development agent]

### Completion Notes List
[To be populated by development agent]

### File List
[To be populated by development agent]

## QA Results
[To be populated by QA agent]
